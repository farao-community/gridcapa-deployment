name: Release job

# Description: This workflow updates the version in the ConfigMap file,
# creates a commit with the updated version, and creates a pull request.

on:
  push:
    branches:
      - add_release_job
  workflow_dispatch:
    inputs:
      releaseVersion:
        description: 'Release version'
        required: true
      environment:
        description: 'Environment (coreso/azure)'
        required: true
      namespace:
        description: 'Namespace (dev/test/prod)'
        required: true

jobs:
  release:
    runs-on: ubuntu-latest
    env:
      RELEASE_VERSION: ${{ github.event.inputs.releaseVersion || '99.99.99' }}
      ENVIRONMENT: ${{ github.event.inputs.environment || 'azure' }}
      NAMESPACE: ${{ github.event.inputs.namespace || 'dev' }}
    steps:
      - name: Checkout
        uses: actions/checkout@v3

      - name: Save environment variables to file
        run: |
          echo "RELEASE_VERSION=${RELEASE_VERSION}" >> $GITHUB_ENV
          echo "ENVIRONMENT=${ENVIRONMENT}" >> $GITHUB_ENV
          echo "NAMESPACE=${NAMESPACE}" >> $GITHUB_ENV

      - name: Find ConfigMap file
        id: find_configmap_file
        run: |
          if [ "${ENVIRONMENT}" == "azure" ]; then
            path="k8s/overlays/azure/${NAMESPACE}/gridcapa-app-env-configmap.yaml"
            sed_pattern="s/Azure .* : [0-9.]\+/Azure ${NAMESPACE} : ${RELEASE_VERSION}/g"
          else
            path="k8s/overlays/coreso/${NAMESPACE}/gridcapa-app-env-configmap.yaml"
            sed_pattern="s/Coreso .* : [0-9.]\+/Coreso ${NAMESPACE} : ${RELEASE_VERSION}/g"
          fi
          echo "configmap_file=${path}" >> $GITHUB_ENV
          echo "sed_pattern=${sed_pattern}" >> $GITHUB_ENV

      - name: Change version in ConfigMap file
        run: |
          sed -i "${{ env.sed_pattern }}" "${{ env.configmap_file }}"

      - name: Commit and tag release version
        uses: stefanzweifel/git-auto-commit-action@master
        with:
          branch: "release-v${{ env.RELEASE_VERSION }}-${{ env.ENVIRONMENT }}-${{ env.NAMESPACE }}"
          create_branch: true
          commit_message: "Prepare release ${{ env.RELEASE_VERSION }} for ${{ env.ENVIRONMENT }}-${{ env.NAMESPACE }}"
          tagging_message: "v${{ env.RELEASE_VERSION }}-${{ env.ENVIRONMENT }}-${{ env.NAMESPACE }}"

      - name: Create Pull Request
        uses: peter-evans/create-pull-request@v3
        with:
          commit-message: "chore: Update version in ConfigMap file"
          title: "Update version to v${RELEASE_VERSION} for ${ENVIRONMENT}-${NAMESPACE}"
          branch: release-v${RELEASE_VERSION}-${ENVIRONMENT}-${NAMESPACE}
          base: main
          labels: "auto-generated"
