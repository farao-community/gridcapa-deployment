name: Release job

# Description: This workflow updates the version in the ConfigMap file,
# creates a commit with the updated version, and creates a pull request.

on:
  push:
    branches:
      - add_release_job
  workflow_dispatch:
    inputs:
      releaseVersion:
        description: 'Release version'
        required: true
        default: '99.99.99'
      environment:
        description: 'Environment (coreso/azure)'
        required: true
        default: 'azure'
      namespace:
        description: 'Namespace (dev/test/prod)'
        required: true
        default: 'dev'

jobs:
  release:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v3

      - name: Save release version to state file
        run: echo "releaseVersion=${{ github.event.inputs.releaseVersion }}" >> $GITHUB_STATE

      - name: Save environment to state file
        run: echo "environment=${{ github.event.inputs.environment }}" >> $GITHUB_STATE

      - name: Save namespace to state file
        run: echo "namespace=${{ github.event.inputs.namespace }}" >> $GITHUB_STATE

      - name: Find ConfigMap file
        id: find_configmap_file
        run: |
          if [ "${{ env.environment }}" == "azure" ]; then
            path="k8s/overlays/azure/${{ env.namespace }}/gridcapa-app-env-configmap.yaml"
            sed_pattern="s/Azure .* : [0-9.]\+/Azure ${{ env.namespace }} : ${{ env.releaseVersion }}/g"
          else
            path="k8s/overlays/coreso/${{ env.namespace }}/gridcapa-app-env-configmap.yaml"
            sed_pattern="s/Coreso .* : [0-9.]\+/Coreso ${{ env.namespace }} : ${{ env.releaseVersion }}/g"
          fi
          echo "::set-output name=configmap_file::$path"
          echo "::set-output name=sed_pattern::$sed_pattern"

      - name: Change version in ConfigMap file
        run: |
          sed -i "${{ steps.find_configmap_file.outputs.sed_pattern }}" ${{ steps.find_configmap_file.outputs.configmap_file }}

      - name: Commit and tag release version
        uses: stefanzweifel/git-auto-commit-action@master
        with:
          branch: release-v${{ env.releaseVersion }}-${{ env.environment }}-${{ env.namespace }}
          create_branch: true
          commit_message: Prepare release ${{ github.event.inputs.releaseVersion }} for ${{ github.event.inputs.environment }}-${{ github.event.inputs.namespace }}
          tagging_message: v${{ github.event.inputs.releaseVersion }}-${{ github.event.inputs.environment }}-${{ github.event.inputs.namespace }}

      - name: Create Pull Request
        uses: peter-evans/create-pull-request@v3
        with:
          commit-message: "chore: Update version in ConfigMap file"
          title: "Update version to v${{ env.releaseVersion }} for ${{ env.environment }}-${{ env.namespace }}"
          branch: release-v${{ env.releaseVersion }}-${{ env.environment }}-${{ env.namespace }}
          base: main
          labels: "auto-generated"
