apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization

resources:
  - ../common
  - ../../../bases/cse-common
  - ../../../bases/cse-export-d2cc
  - ../../../bases/cse-export-idcc
  - ../../../bases/cse-import-d2cc
  - ../../../bases/cse-import-idcc
  - ../../../bases/cse-import-ec-d2cc
  - ../../../bases/cse-import-ec-idcc
  - ../../../bases/swe-d2cc
  - ../../../bases/swe-idcc
  - ../../../bases/swe-idcc-idcf
  - ../../azure-databridge-claims/cse-export-d2cc
  - ../../azure-databridge-claims/cse-export-idcc
  - ../../azure-databridge-claims/cse-import-d2cc
  - ../../azure-databridge-claims/cse-import-idcc
  - ../../azure-databridge-claims/cse-import-ec-d2cc
  - ../../azure-databridge-claims/cse-import-ec-idcc
  - ../../azure-databridge-claims/swe-d2cc
  - ../../azure-databridge-claims/swe-idcc
  - ../../azure-databridge-claims/swe-idcc-idcf
  - apps-metadata-server-configmap.yaml
  - cse-export-d2cc-app-idp-settings-configmap.yaml
  - cse-export-idcc-app-idp-settings-configmap.yaml
  - cse-gridcapa-runner-itools-azure-test-configmap.yaml
  - cse-gridcapa-export-runner-itools-azure-test-configmap.yaml
  - swe-gridcapa-runner-itools-azure-test-configmap.yaml
  - cse-import-d2cc-app-idp-settings-configmap.yaml
  - cse-import-idcc-app-idp-settings-configmap.yaml
  - cse-import-ec-idcc-app-idp-settings-configmap.yaml
  - cse-import-ec-d2cc-app-idp-settings-configmap.yaml
  - swe-d2cc-app-idp-settings-configmap.yaml
  - swe-idcc-app-idp-settings-configmap.yaml
  - swe-idcc-idcf-gridcapa-app-idp-settings-configmap.yaml
  - gridcapa-app-env-configmap.yaml
  - gridcapa-ingress.yaml
  - postgresql-configmap.yaml
  - postgresql-deployment.yaml
  - rao-auto-scale-down.yaml

configMapGenerator:
  - name: env-configmap
    envs: [env.properties]

patches:
  # - Scale-up to 4 instances
  # - Adapt requests/limits
  # - Add ImagePullSecrets to retrieve private gridcapa-rao-runner-with-xpress from p2rte
  - patch: |-
      kind: Deployment
      apiVersion: apps/v1
      metadata:
        name: rao-runner
      spec:
        replicas: 8
        template:
          spec:
            containers:
              - name: rao-runner
                resources:
                  requests:
                    cpu: "14.0"
                    memory: "50Gi"
                  limits:
                    cpu: "16.0"
                    memory: "64Gi"
            imagePullSecrets:
              - name: p2rte-acr-secret
# Scale-up to 4 instances and adapt CSE runner itools config
  - patch: |-
      kind: Deployment
      apiVersion: apps/v1
      metadata:
        name: cse-import-idcc-gridcapa-runner
      spec:
        replicas: 2
        template:
          spec:
            volumes:
              - name: cse-import-idcc-runner-itools-configmap-volume
                configMap:
                  name: cse-runner-itools-azure-test-configmap
  # Scale-up to 4 instances and adapt CSE runner itools config
  - patch: |-
      kind: Deployment
      apiVersion: apps/v1
      metadata:
        name: cse-import-d2cc-gridcapa-runner
      spec:
        replicas: 2
        template:
          spec:
            volumes:
              - name: cse-import-d2cc-runner-itools-configmap-volume
                configMap:
                  name: cse-runner-itools-azure-test-configmap
  # adapt CSE Import EC runner itools config
  - patch: |-
      kind: Deployment
      apiVersion: apps/v1
      metadata:
        name: cse-import-ec-d2cc-gridcapa-runner
      spec:
        replicas: 2
        template:
          spec:
            volumes:
              - name: cse-import-ec-d2cc-runner-itools-configmap-volume
                configMap:
                  name: cse-runner-itools-azure-test-configmap
  # adapt CSE Import EC runner itools config
  - patch: |-
      kind: Deployment
      apiVersion: apps/v1
      metadata:
        name: cse-import-ec-idcc-gridcapa-runner
      spec:
        replicas: 2
        template:
          spec:
            volumes:
              - name: cse-import-ec-idcc-runner-itools-configmap-volume
                configMap:
                  name: cse-runner-itools-azure-test-configmap
  # Scale-up to 2 instances swe-d2cc-runner
  - patch: |-
      kind: Deployment
      apiVersion: apps/v1
      metadata:
        name: swe-d2cc-runner
      spec:
        replicas: 2
  # Scale-up to 2 instances swe-idcc-runner
  - patch: |-
      kind: Deployment
      apiVersion: apps/v1
      metadata:
        name: swe-idcc-runner
      spec:
        replicas: 2
  # Scale-up to x instances swe-idcc-idcf-runner
  - patch: |-
      kind: Deployment
      apiVersion: apps/v1
      metadata:
        name: swe-idcc-idcf-runner
      spec:
        replicas: 2
  # Adapt CSE runner itools config
  - patch: |-
      kind: Deployment
      apiVersion: apps/v1
      metadata:
        name: cse-export-idcc-runner
      spec:
        template:
          spec:
            volumes:
              - name: cse-export-idcc-runner-itools-configmap-volume
                configMap:
                  name: cse-export-runner-itools-azure-test-configmap
  # Adapt CSE runner itools config
  - patch: |-
      kind: Deployment
      apiVersion: apps/v1
      metadata:
        name: cse-export-d2cc-runner
      spec:
        template:
          spec:
            volumes:
              - name: cse-export-d2cc-runner-itools-configmap-volume
                configMap:
                  name: cse-export-runner-itools-azure-test-configmap
  # Adapt SWE D2CC runner itools config
  - patch: |-
      kind: Deployment
      apiVersion: apps/v1
      metadata:
        name: swe-d2cc-runner
      spec:
        template:
          spec:
            volumes:
              - name: swe-d2cc-runner-itools-configmap-volume
                configMap:
                  name: swe-runner-itools-azure-test-configmap
  # Adapt SWE IDCC runner itools config
  - patch: |-
      kind: Deployment
      apiVersion: apps/v1
      metadata:
        name: swe-idcc-runner
      spec:
        template:
          spec:
            volumes:
              - name: swe-idcc-runner-itools-configmap-volume
                configMap:
                  name: swe-runner-itools-azure-test-configmap
  # Adapt SWE IDCC IDCF runner itools config
  - patch: |-
      kind: Deployment
      apiVersion: apps/v1
      metadata:
        name: swe-idcc-idcf-runner
      spec:
        template:
          spec:
            volumes:
              - name: swe-idcc-idcf-runner-itools-configmap-volume
                configMap:
                  name: swe-runner-itools-azure-test-configmap
images:
  - name: apps-metadata-server
    newName: docker.io/bitnami/apache
    newTag: "2.4"
  - name: rabbitmq
    newName: docker.io/rabbitmq
    newTag: management
  - name: minio
    newName: docker.io/bitnami/minio
    newTag: 2021.6.17
  - name: minio-mc
    newName: docker.io/minio/mc
    newTag: RELEASE.2022-05-09T04-08-26Z
  - name: gridsuite-config-notification-server
    newName: docker.io/gridsuite/config-notification-server
    newTag: 0.15.0
  - name: gridsuite-config-server
    newName: docker.io/gridsuite/config-server
    newTag: 0.15.0
  - name: gridcapa-rao-runner
    newName: p2rte.azurecr.io/farao/gridcapa-rao-runner-with-xpress
    newTag: v1.16.1
  - name: gridcapa-app
    newName: docker.io/farao/gridcapa-app
    newTag: v1.9.0-auth
  - name: gridcapa-gateway
    newName: docker.io/farao/gridcapa-gateway
    newTag: 1.0.0
  - name: gridcapa-cse-input-data-bridge
    newName: docker.io/farao/gridcapa-data-bridge
    newTag: v1.2.4
  - name: gridcapa-cse-adapter
    newName: docker.io/farao/gridcapa-cse-adapter
    newTag: v1.13.0
  - name: gridcapa-cse-job-launcher
    newName: docker.io/farao/gridcapa-job-launcher
    newTag: v1.6.0
  - name: gridcapa-cse-rao-logs-dispatcher
    newName: docker.io/farao/gridcapa-rao-logs-dispatcher
    newTag: v1.1.0
  - name: gridcapa-cse-import-runner
    newName: docker.io/farao/gridcapa-cse-cc-import-runner
    newTag: v1.20.0
  - name: gridcapa-cse-export-runner
    newName: docker.io/farao/gridcapa-cse-cc-export-runner
    newTag: v1.20.0
  - name: gridcapa-cse-task-manager
    newName: docker.io/farao/gridcapa-task-manager
    newTag: v1.19.0
  - name: gridcapa-cse-exporter
    newName: docker.io/farao/gridcapa-export
    newTag: v1.5.0
    #SWE
  - name: gridcapa-swe-input-data-bridge
    newName: docker.io/farao/gridcapa-data-bridge
    newTag: v1.2.4
  - name: gridcapa-swe-exporter
    newName: docker.io/farao/gridcapa-export
    newTag: v1.5.0
  - name: gridcapa-swe-adapter
    newName: docker.io/farao/gridcapa-swe-adapter
    newTag: v1.1.0
  - name: gridcapa-swe-job-launcher
    newName: docker.io/farao/gridcapa-job-launcher
    newTag: v1.6.0
  - name: gridcapa-swe-d2cc-rao-logs-dispatcher
    newName: docker.io/farao/gridcapa-rao-logs-dispatcher
    newTag: v1.1.0
  - name: gridcapa-swe-runner
    newName: docker.io/farao/gridcapa-swe-runner
    newTag: v1.12.0
  - name: gridcapa-swe-task-manager
    newName: docker.io/farao/gridcapa-task-manager
    newTag: v1.19.0